---
title: "Summary Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all(reset = T)
library(ggrepel)
library(vegan)
library(patchwork)
```

# Introduction


This is an example of usage of this package on a small set of data, global.tsv. This tsv file contains 8 samples, from 3 different nets. 

The first step is to import the tsv file or files into the environment. To do this, we define a vector containing all the classification of the particles we wish to omit.

# Analyses

## Import data

```{r import}
data <- import.data("data/example/global.tsv",
                    unwanted = c("not-living","duplicate","multiple"))

data_distrib <- get.counts.and.vol(data)

context <- get.info(data,type="sample")
```

We can now start our analysis. 

## Taxonomic composition

```{r, fig.width=10}
ggplot(data_distrib,aes(x=sample_id,y=biovolume))+
  geom_col(aes(fill=category))
```

We can select the 8 most abundant (biovolume) category
 
```{r, fig.width=9,fig.height=7,fig.align="center"}
taxo_plot_categ(data_distrib,"category","biovolume")

taxoplot_biov <- ggplot(data_distrib,aes(x=sample_id,y=biovolume))+
  geom_col(aes(fill=category_plot),col="black")+
  scale_fill_brewer(palette = "Set1")+
  scale_x_discrete(guide = guide_axis(angle = 45))+
  theme_bw()

taxoplot_biov
```

```{r, fig.width=10}
taxoplot_biov_total <- ggplot(data_distrib,aes(x=sample_id,y=biovolume))+
  geom_col(aes(fill=category_plot),col="black",position="fill")+
  scale_fill_brewer(palette = "Set1")+
  scale_x_discrete(guide = guide_axis(angle = 45))+
  theme_bw()

taxoplot_biov_total
```

## Beta_diversity

We can also to principal coordinate analysis, PCoA, for example on biovolumes

```{r, fig.width=10,fig.height=14}
biovolume_df <- get.df.vegan(data_distrib,"biovolume")

d.bray<-vegdist(biovolume_df) # calculate Bray-Curtis distances
pcoa<-cmdscale(d.bray,k=2,eig=T) # PCoA function
pcoa.plot<-data.table(id=row.names(biovolume_df),PCo1=pcoa$points[,1],PCo2=pcoa$points[,2])
pcoa.plot <- merge(pcoa.plot,context[,list(id,sampling_gear)],by="id")

pcoa_biov <- ggplot(pcoa.plot,aes(x=PCo1,y=PCo2,color=sampling_gear)) +
  geom_point(size=3) +
  geom_text_repel(aes(label=id))+
    labs(title="PCoA on biovolumes",
         x = paste("PCo1 ",round(100*pcoa$eig[1]/sum(pcoa$eig))," %"), # percentage explained by the first component
         y = paste("PCo2 ",round(100*pcoa$eig[2]/sum(pcoa$eig))," %"))  +
    theme(plot.title.position="panel")+
  coord_fixed()

taxoplot_biov/pcoa_biov
```

As it is frequent to have problems with the calculation of filtered volumes, you can compare the result of an analysis on **biovolumes** to an analysis on **standardized biovolumes**. If the interpretation of these two plots are similar, then this suggests that the recorded filtered volume is plausible, therefore the concentrations are valid.

```{r, fig.width=10,fig.height=14}
biovolume_df_total <- decostand(biovolume_df,method = "total")
d.bray<-vegdist(biovolume_df_total) # calculate Bray-Curtis distances
pcoa<-cmdscale(d.bray,k=2,eig=T) # PCoA function
pcoa.plot<-data.table(id=row.names(biovolume_df_total),PCo1=pcoa$points[,1],PCo2=pcoa$points[,2])
pcoa.plot <- merge(pcoa.plot,context[,list(id,sampling_gear)],by="id")

pcoa_biov_total <- ggplot(pcoa.plot,aes(x=PCo1,y=PCo2,color=sampling_gear)) +
  geom_point(size=3) +
  geom_text_repel(aes(label=id))+
    labs(title="PCoA on biovolumes",
         x = paste("PCo1 ",round(100*pcoa$eig[1]/sum(pcoa$eig))," %"), # percentage explained by the first component
         y = paste("PCo2 ",round(100*pcoa$eig[2]/sum(pcoa$eig))," %"))  +
    theme(plot.title.position="panel")

taxoplot_biov_total/pcoa_biov_total
```

## NBSS plots

You can also show NBSS plots. These correspond to the normalized biomass size spectra.

```{r nbss, fig.width=10,fig.height=10}

sample_selection <- context[sampling_gear=="net_hsn",id]
data_selection <- data[sample_id%in%sample_selection]

res <- lapply(split(data_selection,by="sample_id"),function(X){
  NBSS.plot(X)
})

wrap_plots(res[1:8],nrow = 3,ncol=3)

```


